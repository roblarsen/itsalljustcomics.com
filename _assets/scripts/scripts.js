angular.module("comicsApp",["comicFilters","comicsFactories"]),angular.module("comicsFactories",[]).factory("dataService",function($http){"use strict";function getRecords(){var records=[];return $http({method:"GET",url:"/data/books.json"}).success(function(data){for(var i=0,len=data.books.length;len>i;i++)if(data.books[i].sales.length)for(var j=0,l=data.books[i].sales.length;l>j;j++)parseFloat(data.books[i].sales[j].price)>=1e5&&records.push({title:data.books[i].title,issue:data.books[i].issue,pedigree:data.books[i].pedigree,collection:data.books[i].collection,provenance:data.books[i].provenance,grade:data.books[i].grade,gradeSrc:data.books[i].gradeSrc,date:data.books[i].sales[j].salesDate,venue:data.books[i].sales[j].venue,price:Math.floor(data.books[i].sales[j].price),link:data.books[i].sales[j].link})}),records}return{getRecords:getRecords}}),angular.module("comicsApp").controller("chartCtrl",["$rootScope","$scope","dataService",function($rootScope,$scope,dataService){"use strict";$scope.items=dataService.getRecords(),$scope.tooltip={price:0},$scope.startYear=1990,$scope.endYear=moment().add(1,"year").year(),$scope.baseline=0,$scope.maxPrice=35e5,$scope.updateTooltip=function(it){$scope.tooltip={price:it.price||0,venue:it.venue,date:it.date,title:it.title,issue:it.issue,pedigree:it.pedigree,collection:it.collection,provenance:it.provenance,gradeSrc:it.gradeSrc,grade:it.grade}},$scope.colorPicker=function(venue){return venue=venue.toLowerCase(),$scope.colors[venue]?$scope.colors[venue]:$scope.colors["default"]},$scope.colors={heritage:"#ECD078",comicconnect:"#D95B43",comiclink:"#C02942",pedigreecomics:"#542437",metropolis:"#53777A","default":"#4286f4"}}]),angular.module("comicsApp").controller("saCtrl",["$scope","$http",function($scope,$http){"use strict";$http({method:"GET",url:"/data/sa-pedigrees.json"}).success(function(data){$scope.items=data.books,$scope.keys=data.keys})}]),angular.module("comicsApp").controller("comicsCtrl",["$scope","$http",function($scope,$http){"use strict";$http({method:"GET",url:"/data/books.json"}).success(function(data){$scope.items=data.books;for(var item,titles=[],pedigrees=[],publishers=[],venues=[],i=0;i<$scope.items.length;i++)if(item=$scope.items[i],_.includes(titles,item.title)||titles.push(item.title),item.pedigree&&(_.includes(pedigrees,item.pedigree)||pedigrees.push(item.pedigree)),item.publisher&&(_.includes(publishers,item.publisher)||publishers.push(item.publisher)),item.sales.length)for(var j=0;j<item.sales.length;j++)_.includes(venues,item.sales[j].venue)||venues.push(item.sales[j].venue);null!==document.location.search&&($scope.search=document.location.search.slice(1,document.location.search.length)),$scope.sort=["title","issue","-grade"],$scope.titles=titles,$scope.publishers=publishers,$scope.pedigrees=pedigrees,$scope.venues=venues,$scope.uid=data.books.length}),$scope.sales=[],$scope.addItem=function(item){item.sales=$scope.sales,item.uid=$scope.uid,$scope.uid++,$scope.items.push(item),$scope.item={},$scope.sales=[],item.pedigree&&(_.includes($scope.pedigrees,item.pedigree)||$scope.pedigrees.push(item.pedigree)),item.publisher&&(_.includes($scope.publishers,item.publisher)||$scope.publishers.push(item.publisher)),_.includes($scope.titles,item.title)||$scope.titles.push(item.title);for(var items=$scope.items,len=items.length,i=0;len>i;i++)delete items[i].$$hashKey;$http.post("/data/index.php",angular.toJson(items)).success(function(){})},$scope.addSale=function(sale){$scope.sales.push(_.clone(sale));for(var val in sale)sale.hasOwnProperty(val)&&delete sale[val]},$scope.sorter=function(sort){if($scope.sort[0].indexOf(sort)>-1&&"-"===$scope.sort[0].charAt(0)&&($scope.sort[0]=sort.slice(1)),$scope.sort[0].indexOf(sort)>-1&&-1===$scope.sort[0].indexOf("-"))$scope.sort[0]="-"+sort;else{var tmp=[];tmp[0]=sort;for(var i=0;i<$scope.sort[0].length;i++)$scope.sort[i]!==sort&&tmp.push($scope.sort[i]);$scope.sort=tmp}}}]),angular.module("comicsApp").controller("recordCtrl",["$rootScope","$scope","dataService",function($rootScope,$scope,dataService){"use strict";$scope.items=dataService.getRecords(),$scope.sort="-price",null!==document.location.search&&($scope.search=document.location.search.slice(1,document.location.search.length)),$scope.sorter=function(sort){$scope.sort.indexOf(sort)>-1&&"-"===$scope.sort.charAt(0)&&($scope.sort=sort.slice(1)),$scope.sort.indexOf(sort)>-1&&-1===$scope.sort.indexOf("-")?$scope.sort="-"+sort:$scope.sort=sort}}]),angular.module("comicsApp").directive("verticalLines",function(){"use strict";function link(scope,element,attrs){var years=attrs.endYear-attrs.startYear;years++;var increment=949/years;scope.newXs=[];for(var strokeWidth=1,i=0;years>i;i++)strokeWidth=i%5===0?2:1,scope.newXs.push({x:i*increment+75,strokeWidth:strokeWidth})}return{transclude:!0,templateUrl:"_assets/partials/vertical-lines.html",link:link}}).directive("horizontalLines",function(){"use strict";function link(scope,element,attrs){var priceRange=attrs.maxPrice-attrs.baseline,prices=priceRange/1e5,increment=650/prices;scope.newYs=[];for(var strokeWidth=1,i=0;prices>i;i++)strokeWidth=i%5===0?3:1,scope.newYs.push({y:i*increment+25,strokeWidth:strokeWidth})}return{transclude:!0,templateUrl:"_assets/partials/horizontal-lines.html",link:link}}).directive("yearLabels",function(){"use strict";function link(scope,element,attrs){var years=attrs.endYear-attrs.startYear;years++;var increment=949/years;scope.years=[];for(var i=0;years>i;i++)i%5===0&&scope.years.push({x:i*increment+75,year:parseInt(attrs.startYear)+i})}return{transclude:!0,templateUrl:"_assets/partials/year-labels.html",link:link}}).directive("dollarLabels",function(){"use strict";function link(scope,element,attrs){var priceRange=attrs.maxPrice-attrs.baseline,prices=priceRange/1e5,increment=650/prices;scope.dollars=[];for(var i=0;prices>=i;i++)i%5===0&&scope.dollars.push({y:650-i*increment+25,value:1e5*i})}return{transclude:!0,templateUrl:"_assets/partials/dollars.html",link:link}}),angular.module("comicsApp").directive("salesPoints",function(){"use strict";function link(scope,element,attrs){var priceRange=attrs.maxPrice-attrs.baseline,priceIncrement=priceRange/650,totalYears=attrs.endYear-attrs.startYear;totalYears++;var totalMonths=12*totalYears,monthIncrement=950/totalMonths;scope.xDate=function(input){if(input){var date=input.split("-"),years=date[0]-attrs.startYear,months=12*years+parseInt(date[1]);return 73+months*monthIncrement}},scope.yPrice=function(input){return input?675-input/priceIncrement:void 0}}return{transclude:!0,templateUrl:"_assets/partials/sales-points.html",link:link}}),angular.module("comicFilters",[]).filter("srcFilter",function(){return function(input){return("cgc"===input||"pgx"===input||"cbcs"===input)&&(input=input.toUpperCase()),input}}).filter("capitalize",function(){return function(input){return input?input.charAt(0).toUpperCase()+input.slice(1):void 0}}).filter("sellers",function(){var sellers={heritage:"Heritage",comicconnect:"ComicConnect",comiclink:"ComicLink",pedigreecomics:"Pedigree",metropolis:"Metropolis",ebay:"eBay",unknown:"Seller unknown"};return function(input){if(input){var key=input.toLowerCase();return sellers[key]?sellers[key]:input.charAt(0).toUpperCase()+input.slice(1)}}}).filter("saneDate",function(){return function(input){return input?"1900-01-01"===input?" on an unknown date ":input.indexOf("01-01")>-1?"in "+input.substring(0,4):"on "+input.replace(/-/g,"/"):void 0}}).filter("xDate",function(){return function(input){if(void 0!==input){var date=input.split("-"),years=date[0]-1990,months=12*years+parseInt(date[1]);return 64+3*months}}}).filter("yPrice",function(){return function(input){return input?673-input/5263.15789473684:void 0}}),angular.module("comicsApp").run(["$templateCache",function($templateCache){"use strict";$templateCache.put("_assets/partials/dollars.html",'<text ng-repeat="dollarlabel in dollars" ng-attr-y="{{dollarlabel.y}}" x="10" fill="#666666" class="dollars">{{dollarlabel.value | currency:"$":0}}</text>'),$templateCache.put("_assets/partials/horizontal-lines.html",'<line ng-repeat="y in newYs track by $index" fill="none" stroke="#7BC791" ng-attr-stroke-width="{{y.strokeWidth}}" stroke-miterlimit="10" x1="0" ng-attr-y1="{{y.y}}" x2="990" ng-attr-y2="{{y.y}}"></line>'),$templateCache.put("_assets/partials/sale.html",'<span class="sales-price" data-ng-show="sl.link"> <a href="{{sl.link}}">{{sl.price | currency}}</a> </span> <span class="sales-price" data-ng-hide="sl.link"> {{sl.price | currency}} </span> <span class="sales-venue" data-ng-show="sl.venue === \'Seller unknown\'"> with an unknown seller </span> <span class="sales-venue" data-ng-show="sl.venue === \'private sale\'"> in a private sale </span> <span class="sales-venue" data-ng-show="sl.venue !== \'private sale\'\r\n              &&\r\n              sl.venue !== \'Seller unknown\'"> at {{sl.venue|capitalize}} </span> <span class="sales-date"> {{sl.salesDate | saneDate}} </span>'),$templateCache.put("_assets/partials/sales-points.html",'<circle data-ng-repeat="it in items | filter : venues" opacity="0.8" data-ng-attr-fill="{{colorPicker(it.venue)}}" data-ng-attr-cx="{{xDate(it.date)}}" data-ng-mouseover="updateTooltip(it)" data-ng-mouseout="updateTooltip(0)" data-ng-attr-cy="{{yPrice(it.price)}}" r="7"></circle> <rect data-ng-show="tooltip.price" data-ng-model="tooltip" transform="translate(-180,-60)" data-ng-attr-x="{{xDate(tooltip.date)}}" data-ng-attr-y="{{yPrice(tooltip.price)}}" width="150" height="80" fill="white" stroke="" style="filter:url(#drop-shadow)"></rect> <text data-ng-show="tooltip.price" data-ng-model="tooltip" transform="translate(-170,-50)" data-ng-attr-x="{{xDate(tooltip.date)}}" data-ng-attr-y="{{yPrice(tooltip.price)}}">{{tooltip.title}} {{tooltip.issue}}</text> <text data-ng-show="tooltip.price" data-ng-model="tooltip" transform="translate(-170,-35)" data-ng-attr-x="{{xDate(tooltip.date)}}" data-ng-attr-y="{{yPrice(tooltip.price)}}">{{tooltip.pedigree}}{{tooltip.collection}}{{tooltip.provenance}} {{tooltip.gradeSrc | srcFilter}} {{tooltip.grade}}</text> <text data-ng-show="tooltip.price" data-ng-model="tooltip" transform="translate(-170,-20)" data-ng-attr-x="{{xDate(tooltip.date)}}" data-ng-attr-y="{{yPrice(tooltip.price)}}">{{tooltip.price|currency}}</text> <text data-ng-show="tooltip.price" data-ng-model="tooltip" transform="translate(-170,-5)" data-ng-attr-x="{{xDate(tooltip.date)}}" data-ng-attr-y="{{yPrice(tooltip.price)}}">{{tooltip.date}}</text> <text data-ng-show="tooltip.price" data-ng-model="tooltip" transform="translate(-170,10)" data-ng-attr-x="{{xDate(tooltip.date)}}" data-ng-attr-y="{{yPrice(tooltip.price)}}">{{tooltip.venue|sellers}}</text>'),$templateCache.put("_assets/partials/vertical-lines.html",'<line ng-repeat="x in newXs" fill="none" stroke="#7D7D7D" stroke-miterlimit="10" ng-attr-x1="{{x.x}}" y1="25" ng-attr-x2="{{x.x}}" y2="675" ng-attr-stroke-width="{{x.strokeWidth}}"></line>'),$templateCache.put("_assets/partials/year-labels.html",'<text ng-repeat="year in years" ng-attr-x="{{year.x}}" y="692" fill="#666666" class="years">{{year.year}}</text>')}]);